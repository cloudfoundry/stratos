---
platform: linux
inputs:
- name: helm-release
- name: helm-chart-repo
- name: HELM_CHART_REPO_FOLDER
image_resource:
  type: docker-image
  source:
   # Generated using scripts/Dockerfile.stratos-ci
   repository: splatform/stratos-ci-concourse
   tag: "latest"
run:
  path: bash
  args:
    - -c
    - |
      # Initialize Helm for client-side use
      helm init --client-only
      ROOT_DIR=$PWD
      HELM_RELEASE=${ROOT_DIR}/helm-release
      HELM_CHART_REPO=${ROOT_DIR}/helm-chart-repo
      
      ls -al ${HELM_RELEASE}

      pushd ${HELM_RELEASE}
      VERSION=$(cat version)
      CHART=$(ls console-helm-chart-*.tgz)
      popd

      cd ${HELM_CHART_REPO}
      cd ./${HELM_CHART_REPO_FOLDER}/console
      ls -al
      CHART_VERSION=$(cat Chart.yaml | grep "version:" | cut -d " " -f 2)

      echo "New Chart version     : ${VERSION}"
      echo "Existing Chart version: ${CHART_VERSION}"

      if [ "$CHART_VERSION" == "$VERSION" ]; then
        echo "This version has already been processed"
        exit 0
      fi

      echo "Creating PR for Helm Chart"

      # Unpack the Helm Chart, patch it and create the PR

      # Unpack over the existing chart
      cd ..
      tar -xvf ${HELM_RELEASE}/${CHART}

      cd console
      git status

      # Need to patch the registry
      export TERM=xterm
      git diff

      echo ${RELEASE_DOCKER_REGISTRY}
      echo ${RELEASE_DOCKER_ORG}












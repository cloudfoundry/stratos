<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.58">
<title data-react-helmet="true">bosh-metrics | STRATOS</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="bosh-metrics | STRATOS"><meta data-react-helmet="true" name="description" content="Connecting Prometheus-boshrelease to Stratos"><meta data-react-helmet="true" property="og:description" content="Connecting Prometheus-boshrelease to Stratos"><meta data-react-helmet="true" property="og:url" content="https://stratos.app/docs/guides/metrics/bosh-metrics"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://stratos.app/docs/guides/metrics/bosh-metrics"><link rel="stylesheet" href="/styles.2e94191b.css">
<link rel="preload" href="/styles.78aa2ed4.js" as="script">
<link rel="preload" href="/runtime~main.3a6a7f77.js" as="script">
<link rel="preload" href="/main.8d981086.js" as="script">
<link rel="preload" href="/1.ac640629.js" as="script">
<link rel="preload" href="/2.b943da11.js" as="script">
<link rel="preload" href="/48.42bd91cb.js" as="script">
<link rel="preload" href="/49.6e8e7afa.js" as="script">
<link rel="preload" href="/20ac7829.e87d6cb5.js" as="script">
<link rel="preload" href="/17896441.e643ff38.js" as="script">
<link rel="preload" href="/bd4aa359.683dd25c.js" as="script">
</head>
<body>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.png" alt="Stratos"><strong class="navbar__title">STRATOS</strong></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a href="https://github.com/cloudfoundry/stratos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.png" alt="Stratos"><strong class="navbar__title">STRATOS</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a href="https://github.com/cloudfoundry/stratos" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><main class="docMainContainer_FFX1"><div class="container padding-vert--lg docItemWrapper_1cc7"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">bosh-metrics</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="connecting-prometheus-boshrelease-to-stratos"></a>Connecting Prometheus-boshrelease to Stratos<a aria-hidden="true" tabindex="-1" class="hash-link" href="#connecting-prometheus-boshrelease-to-stratos" title="Direct link to heading">#</a></h1><p>Stratos can show some metrics stored in Prometheus.</p><p>A Prometheus server is required with a firehose exporter configured to take metrics from the Cloud Foundry Firehose and store them in the Prometheus server.</p><p>One option for deploying and configuring such a Prometheus server is with <a href="https://github.com/bosh-prometheus/prometheus-boshrelease.git">prometheus-boshrelease</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="configuring-prometheus-boshrelease-for-use-with-stratos"></a>Configuring Prometheus-boshrelease for use with Stratos<a aria-hidden="true" tabindex="-1" class="hash-link" href="#configuring-prometheus-boshrelease-for-use-with-stratos" title="Direct link to heading">#</a></h2><p>In order for Stratos to work with your Prometheus BOSH release, when deploying <code>prometheus-boshrelease</code> you need to set the <code>metrics_environment</code> value.</p><p>The <code>metrics_environment</code> value must be set to the value of the <code>doppler_logging_endpoint</code> for your Cloud Foundry, with the prefixing <code>wss://</code> protocol removed.</p><p>For example, for PCF Dev, you would set the <code>metrics_environment</code> value when deploying with bosh, by adding the following to your <code>bosh deploy</code> command:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">-v metrics_environment=doppler.local.pcfdev.io:443</span></div></div></div></div></div><p>Once deployed, you should wait until the <code>firehose</code> target is available and its status is <code>UP</code>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="connecting-prometheus-to-stratos"></a>Connecting Prometheus to Stratos<a aria-hidden="true" tabindex="-1" class="hash-link" href="#connecting-prometheus-to-stratos" title="Direct link to heading">#</a></h2><p>To view metrics within Stratos, you must connect the Prometheus server to Stratos, to do so:</p><ol><li>Go to the endpoints view</li><li>Click the &#x27;+&#x27; icon to register a new endpoint</li><li>Select the endpoint type <code>Metrics</code></li><li>Enter a memorable name for your metrics endpoint for the <code>Name</code></li><li>Enter the URL of the Prometheus server for the <code>Endpoint Address</code></li><li>Click &#x27;Finish`</li><li>Click on the three-dot menu icon on the right-hand-side of the endpoint you just added above in the endpoints list and click the menu icon</li><li>Click &#x27;Connect&#x27; in the pop-up menu</li><li>Change the <code>Auth Type</code> to <code>No Authentication</code></li><li>Check the <code>Share this endpoint connection</code> - this allows all users to view metrics using this connection. Note that only Administrators will be able to view Cell metrics and that users can only view Application metrics for applications that they have permissions to view.</li><li>Click <code>Connect</code></li></ol><p>The view should refresh to show the Metrics endpoint. You can click on the endpoint name in the table to show some basic metadata about the metrics endpoint. If everything is configured correctly, it should show you that the metrics endpoint is providing metrics for your Cloud Foundry deployment.</p><p>Metrics should now be available on the view for an Application and also on the <code>Cells</code> tab of the Cloud Foundry view.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="pcf-dev-example"></a>PCF Dev Example<a aria-hidden="true" tabindex="-1" class="hash-link" href="#pcf-dev-example" title="Direct link to heading">#</a></h2><p>The instructions below illiustrate how to deploy and configure <code>prometheus-boshrelease</code> using bosh-lite and a local PCF Dev deployment.</p><p>Follow instructions <a href="https://bosh.io/docs/quick-start/" target="_blank" rel="noopener noreferrer">here</a> to bring up a local bosh-lite deployment.</p><p>Run these two steps to update the deployment and load the stemcell:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">bosh -e vbox update-cloud-config bosh-deployment/warden/cloud-config.yml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">bosh -e vbox upload-stemcell https://bosh.io/d/stemcells/bosh-warden-boshlite-ubuntu-trusty-go_agent?v=3468.17 \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --sha1 1dad6d85d6e132810439daba7ca05694cec208ab</span></div></div></div></div></div><p>Clone the <a href="https://github.com/bosh-prometheus/prometheus-boshrelease" target="_blank" rel="noopener noreferrer">prometheus-boshrelease</a> GitHub repository and change directory into it:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">git clone https://github.com/bosh-prometheus/prometheus-boshrelease.git</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cd prometheus-boshrelease</span></div></div></div></div></div><p>You need to create two UAA Clients (ensure you have the <code>uaac</code> CLI installed):</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">uaac target https://login.plocal.pcfdev.io --skip-ssl-validation</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">uaac token client get admin -s admin-client-secret</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">uaac client add cf_exporter \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --name cf_exporter \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --secret prometheus-client-secret \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --authorized_grant_types client_credentials,refresh_token \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --authorities cloud_controller.admin_read_only \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --scope openid,cloud_controller.admin_read_only</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">uaac client add firehose_exporter \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --name firehose_exporter \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --secret prometheus-client-secret \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --authorized_grant_types client_credentials,refresh_token \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --authorities doppler.firehose \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --scope openid,doppler.firehose</span></div></div></div></div></div><p>Store the Bosh CA Certificate in a file:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">echo $BOSH_CA_CERT &gt; bosh_ca_cert</span></div></div></div></div></div><p>Get the BOSH URL by examining your config file:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">cat ~/.bosh/config</span></div></div></div></div></div><p>Find the <code>vbox</code> environment and make a note of the url field - set an environment variable <code>BOSH_IP</code> to this value.</p><p>You can now deploy Prometheus Bosh Release with:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">bosh -d prometheus deploy manifests/prometheus.yml \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --vars-store tmp/deployment-vars.yml \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -o manifests/operators/monitor-bosh.yml \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -v metrics_environment=doppler.local.pcfdev.io:443 \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -o manifests/operators/monitor-cf.yml \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -v system_domain=local.pcfdev.io \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -v metron_deployment_name=local.pcfdev.io \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -v uaa_clients_cf_exporter_secret=prometheus-client-secret \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -v uaa_clients_firehose_exporter_secret=prometheus-client-secret \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -v traffic_controller_external_port=443 \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -v skip_ssl_verify=true \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -v bosh_password=${BOSH_CLIENT_SECRET} \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -v bosh_username=${BOSH_CLIENT} \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -v bosh_url=https://${BOSH_IP}:25555 \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --var-file bosh_ca_cert=bosh_ca_cert</span></div></div></div></div></div><p>Wait for deployment to complete.</p><p>List the instances in the deployment with:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">bosh instances -d prometheus</span></div></div></div></div></div><p>Find the IP Address for the <code>prometheus2</code> instance. The Prometheus endpoint will be: <code>http://IP:9090</code>.</p><p>Open a web browser and load the Prometheus URL. open the <code>Status</code> menu and select targets. Refresh the page until the firehose target is up.</p><blockquote><p>Note: It can take a few minutes before all of the targets appear in Prometheus and their state becomes <code>UP</code>. You should see targets named <code>bosh</code>, <code>cf</code> and <code>firehose</code> as well as many others if everything is working correctly.</p></blockquote><p>You should now be able to follow the <a href="#connecting-prometheus-to-stratos">Connecting Prometheus to Stratos</a> instructions for registering and connecting Prometheus to Stratos.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/cloudfoundry/stratos/edit/master/website/docs/guides/metrics/bosh-metrics.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#configuring-prometheus-boshrelease-for-use-with-stratos" class="table-of-contents__link">Configuring Prometheus-boshrelease for use with Stratos</a></li><li><a href="#connecting-prometheus-to-stratos" class="table-of-contents__link">Connecting Prometheus to Stratos</a></li><li><a href="#pcf-dev-example" class="table-of-contents__link">PCF Dev Example</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/doc2/">Deploying Stratos</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://cloudfoundry.slack.com/?redir=%2Fmessages%2Fstratos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack</a></li><li class="footer__item"><a href="https://github.com/cloudfoundry/stratos" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/talks">Presentations and Talks</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2020 Cloud Foundry Foundation</div></div></div></footer></div>
<script src="/styles.78aa2ed4.js"></script>
<script src="/runtime~main.3a6a7f77.js"></script>
<script src="/main.8d981086.js"></script>
<script src="/1.ac640629.js"></script>
<script src="/2.b943da11.js"></script>
<script src="/48.42bd91cb.js"></script>
<script src="/49.6e8e7afa.js"></script>
<script src="/20ac7829.e87d6cb5.js"></script>
<script src="/17896441.e643ff38.js"></script>
<script src="/bd4aa359.683dd25c.js"></script>
</body>
</html>